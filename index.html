<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ï‡§≤‡•ç‡§Ø‡§æ‡§£ ‡§∂‡§§‡§æ‡§¨‡•ç‡§¶‡•Ä ‡§µ‡§∞‡•ç‡§∑ - Address Update</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 50%, #fff9e6 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(218, 165, 32, 0.15);
            max-width: 600px;
            width: 100%;
            padding: 40px;
            animation: fadeIn 0.5s ease;
            border: 2px solid #f5e6c3;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header-section {
            margin-bottom: 30px;
            border-bottom: 3px solid #d4a017;
            padding-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 30px;
        }
        
        .header-text {
            flex: 1;
            text-align: left;
        }
        
        .header-image {
            width: var(--logo-size, 180px);
            height: var(--logo-size, 180px);
            object-fit: contain;
            flex-shrink: 0;
        }
        
        h1 {
            color: #c17817;
            font-size: 28px;
            margin: 0 0 10px 0;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(193, 120, 23, 0.1);
        }
        
        .sub-heading {
            color: #8b6914;
            font-size: 16px;
            font-weight: 600;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sub-heading-note {
            color: #666;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
            font-style: italic;
        }
        
        .otp-section {
            margin-bottom: 30px;
        }
        
        .otp-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: stretch;
        }
        
        .otp-input-group input {
            flex: 1;
        }
        
        .otp-input-group button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #d4a017 0%, #c17817 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .otp-input-group button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 160, 23, 0.4);
            background: linear-gradient(135deg, #e5b01f 0%, #d08820 100%);
        }
        
        .otp-input-group button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: #cccccc;
        }
        
        .otp-countdown {
            display: inline-block;
            margin-left: 5px;
            font-weight: 700;
            color: #c17817;
        }
        
        .otp-message {
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            text-align: center;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .otp-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .otp-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .otp-message.info {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .resend-timer {
            text-align: center;
            color: #c17817;
            font-size: 13px;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .resend-timer button {
            background: none;
            border: none;
            color: #c17817;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 600;
            font-size: 13px;
            padding: 5px 10px;
        }
        
        .resend-timer button:hover {
            color: #8b6914;
        }
        
        .customer-search-section {
            background: #fffbf0;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #f5e6c3;
            animation: fadeIn 0.5s ease;
        }
        
        .customer-search-section h3 {
            color: #c17817;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .customer-search-section p {
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: stretch;
        }
        
        .search-input-group input {
            flex: 1;
        }
        
        .search-input-group button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #d4a017 0%, #c17817 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .search-input-group button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 160, 23, 0.4);
            background: linear-gradient(135deg, #e5b01f 0%, #d08820 100%);
        }
        
        .search-input-group button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .update-phone-section {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #81c784;
        }
        
        .update-phone-section h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: white;
        }
        
        input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            color: #666;
        }
        
        input:not(:disabled):focus, textarea:focus {
            outline: none;
            border-color: #d4a017;
            box-shadow: 0 0 0 3px rgba(212, 160, 23, 0.1);
        }
        
        .char-count {
            text-align: right;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .pincode-status {
            font-size: 12px;
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
        }
        
        .pincode-status.loading {
            color: #c17817;
            background-color: #fffbf0;
            border: 1px solid #f5e6c3;
        }
        
        .pincode-status.success {
            color: #28a745;
            background-color: #d4edda;
        }
        
        .pincode-status.error {
            color: #dc3545;
            background-color: #f8d7da;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #d4a017 0%, #c17817 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(212, 160, 23, 0.4);
            background: linear-gradient(135deg, #e5b01f 0%, #d08820 100%);
        }
        
        .submit-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .required {
            color: #e74c3c;
        }
        
        .already-submitted {
            text-align: center;
            padding: 40px 20px;
            animation: fadeIn 0.5s ease;
        }
        
        .already-submitted h2 {
            color: #c17817;
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .already-submitted p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 249, 230, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            background: white;
            padding: 30px 40px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(212, 160, 23, 0.3);
            border: 2px solid #f5e6c3;
        }
        
        .spinner {
            border: 4px solid #f5e6c3;
            border-top: 4px solid #d4a017;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-spinner p {
            color: #333;
            font-weight: 500;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
                border-radius: 10px;
            }
            
            .header-section {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 15px;
            }
            
            .header-text {
                text-align: center;
            }
            
            .header-image {
                width: var(--logo-size-mobile, 126px);
                height: var(--logo-size-mobile, 126px);
            }
            
            h1 {
                font-size: 20px;
            }
            
            .otp-input-group {
                flex-direction: column;
            }
            
            .otp-input-group button {
                width: 100%;
            }
            
            .search-input-group {
                flex-direction: column;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 0;
            }
            
            .form-row .form-group {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <div class="header-text">
                <h1>‡§ï‡§≤‡•ç‡§Ø‡§æ‡§£ ‡§∂‡§§‡§æ‡§¨‡•ç‡§¶‡•Ä ‡§µ‡§∞‡•ç‡§∑</h1>
                <div class="sub-heading">Kalyan 2026</div>
                <div class="sub-heading-note">Address Update Form</div>
            </div>
            <img src="https://raw.githubusercontent.com/cloudhostadmin/KALYAN_CENTURY_2026/main/kal2026.jpeg" alt="Kalyan Logo" class="header-image" id="rightLogo">
        </div>
        
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p id="loadingMessage">Processing...</p>
            </div>
        </div>
        
        <div id="alreadySubmitted" class="already-submitted hidden">
            <h2>‚úÖ Address Updated Successfully</h2>
            <p>Your address has been updated in our records.</p>
            <p style="margin-top: 10px; color: #999;">Thank you for updating your information!</p>
        </div>
        
        <!-- OTP Verification Section -->
        <div id="otpSection" class="otp-section">
            <div class="form-group">
                <label for="mobileNumber">Mobile Number <span class="required">*</span></label>
                <div class="otp-input-group">
                    <input type="tel" id="mobileNumber" name="mobileNumber" required pattern="[0-9]{10}" maxlength="10" placeholder="Enter 10-digit mobile number" inputmode="numeric">
                    <button type="button" id="sendOtpBtn" onclick="secureOTPManager.sendOTP()">Send OTP</button>
                </div>
            </div>
            
            <div id="otpVerificationGroup" class="form-group hidden">
                <label for="otpInput">Enter OTP <span class="required">*</span></label>
                <div class="otp-input-group">
                    <input type="text" id="otpInput" maxlength="6" placeholder="Enter 6-digit OTP" inputmode="numeric">
                    <button type="button" id="verifyOtpBtn" onclick="secureOTPManager.verifyOTP()">Verify OTP</button>
                </div>
                <div id="resendTimer" class="resend-timer hidden"></div>
            </div>
            
            <div id="otpMessage" class="otp-message hidden"></div>
        </div>
        
        <!-- Customer Search Section -->
        <div id="customerSearchSection" class="customer-search-section hidden">
            <h3>üîç Mobile Number Not Found</h3>
            <p>Your mobile number is not registered. Please enter your <strong>Customer ID</strong> and <strong>Pincode</strong>:</p>
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                üí° <strong>Tip:</strong> You can enter just the number from your ID<br>
                Example: For "HIN/S/H/REG/1Y/623757", enter "623757"
            </p>
            <div class="search-input-group">
                <input type="text" id="customerIdSearch" placeholder="Full ID or number (e.g., 623757)">
                <input type="text" id="pincodeSearch" placeholder="6-digit Pincode" pattern="[0-9]{6}" maxlength="6" inputmode="numeric">
                <button type="button" onclick="secureDataManager.searchByIdAndPincode()">Search</button>
            </div>
            
            <!-- Update Phone Section -->
            <div id="updatePhoneSection" class="update-phone-section hidden">
                <h4>üì± Update Mobile Number</h4>
                <p style="font-size: 13px; margin-bottom: 10px;">Record found, but phone doesn't match. Update it?</p>
                <div class="search-input-group">
                    <input type="tel" id="newMobileNumber" placeholder="Enter new 10-digit mobile" pattern="[0-9]{10}" maxlength="10" inputmode="numeric">
                    <button type="button" onclick="secureDataManager.updateMobile()">Update Phone</button>
                </div>
            </div>
        </div>
        
        <!-- Main Form -->
        <form id="kalyanForm" class="hidden">
            <div class="form-group">
                <label for="customerId">Customer ID <span class="required">*</span></label>
                <input type="text" id="customerId" name="customerId" required disabled>
            </div>
            
            <div class="form-group">
                <label for="firstName">First Name <span class="required">*</span></label>
                <input type="text" id="firstName" name="firstName" required>
            </div>
            
            <div class="form-group">
                <label for="lastName">Last Name <span class="required">*</span></label>
                <input type="text" id="lastName" name="lastName" required>
            </div>
            
            <div class="form-group">
                <label for="address1">Address 1 <span class="required">*</span></label>
                <input type="text" id="address1" name="address1" required maxlength="40">
                <div class="char-count"><span id="address1Count">0</span>/40</div>
            </div>
            
            <div class="form-group">
                <label for="address2">Address 2 <span class="required">*</span></label>
                <input type="text" id="address2" name="address2" required maxlength="40">
                <div class="char-count"><span id="address2Count">0</span>/40</div>
            </div>
            
            <div class="form-group">
                <label for="address3">Address 3</label>
                <input type="text" id="address3" name="address3" maxlength="40">
                <div class="char-count"><span id="address3Count">0</span>/40</div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="pincode">Pincode <span class="required">*</span></label>
                    <input type="text" id="pincode" name="pincode" required pattern="[0-9]{6}" maxlength="6" placeholder="6-digit" inputmode="numeric">
                    <div id="pincodeStatus" class="pincode-status" style="display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label for="city">City <span class="required">*</span></label>
                    <input type="text" id="city" name="city" required>
                </div>
                
                <div class="form-group">
                    <label for="state">State <span class="required">*</span></label>
                    <input type="text" id="state" name="state" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="emailId">Email ID</label>
                <input type="email" id="emailId" name="emailId" placeholder="Optional" inputmode="email">
            </div>
            
            <button type="submit" id="submitBtn" class="submit-btn">Submit Address Update</button>
        </form>
    </div>
    
    <script>
        'use strict';
        
        // ‚úÖ SECURITY: Freeze configuration to prevent tampering
        const CONFIG = Object.freeze({
            GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwc-al3WcElt-vYA-2q-pLKs-LVuoAiL_2ytHMdVVtTMwm0ViExFL-uBuzqEaLXQqqa/exec',
            OTP_COOLDOWN_TIME: 60, // 60 seconds = 1 minute
            OTP_RESEND_TIME: 60,
            MAX_RETRY_ATTEMPTS: 3,
            REQUEST_TIMEOUT: 30000 // 30 seconds
        });
        
        // ‚úÖ SECURITY: Private state management using closure
        const secureStateManager = (() => {
            let state = {
                otpSent: false,
                otpVerified: false,
                mobile: null,
                customerData: null,
                rowIndex: null,
                cooldownTimer: null,
                resendTimer: null,
                retryCount: 0
            };
            
            return {
                get: (key) => state[key],
                set: (key, value) => { state[key] = value; },
                reset: () => {
                    if (state.cooldownTimer) clearInterval(state.cooldownTimer);
                    if (state.resendTimer) clearInterval(state.resendTimer);
                    state = {
                        otpSent: false,
                        otpVerified: false,
                        mobile: null,
                        customerData: null,
                        rowIndex: null,
                        cooldownTimer: null,
                        resendTimer: null,
                        retryCount: 0
                    };
                }
            };
        })();
        
        // ‚úÖ DOM Elements Manager
        const DOM = (() => {
            const ids = {
                form: 'kalyanForm',
                submitBtn: 'submitBtn',
                alreadySubmitted: 'alreadySubmitted',
                loadingOverlay: 'loadingOverlay',
                loadingMessage: 'loadingMessage',
                otpSection: 'otpSection',
                otpVerificationGroup: 'otpVerificationGroup',
                otpMessage: 'otpMessage',
                resendTimer: 'resendTimer',
                customerSearchSection: 'customerSearchSection',
                updatePhoneSection: 'updatePhoneSection',
                mobileInput: 'mobileNumber',
                otpInput: 'otpInput',
                sendOtpBtn: 'sendOtpBtn',
                verifyOtpBtn: 'verifyOtpBtn',
                customerIdSearch: 'customerIdSearch',
                pincodeSearch: 'pincodeSearch',
                newMobileNumber: 'newMobileNumber',
                customerId: 'customerId',
                firstName: 'firstName',
                lastName: 'lastName',
                address1: 'address1',
                address2: 'address2',
                address3: 'address3',
                pincode: 'pincode',
                city: 'city',
                state: 'state',
                emailId: 'emailId'
            };
            
            const cache = {};
            
            return {
                get: (key) => {
                    if (!cache[key]) {
                        cache[key] = document.getElementById(ids[key]);
                    }
                    return cache[key];
                }
            };
        })();
        
        // ‚úÖ SECURITY: Secure API Manager with rate limiting and error handling
        const secureAPIManager = (() => {
            const requestQueue = [];
            let processing = false;
            
            const sanitizeInput = (str) => {
                if (typeof str !== 'string') return str;
                return str.replace(/[<>'"]/g, '');
            };
            
            const makeRequest = async (url, options = {}) => {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.REQUEST_TIMEOUT);
                
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return { success: true, data };
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    
                    if (error.name === 'AbortError') {
                        return { success: false, error: 'Request timeout. Please try again.' };
                    }
                    
                    return { success: false, error: error.message || 'Network error occurred' };
                }
            };
            
            return {
                get: async (action, params = {}) => {
                    const sanitizedParams = {};
                    for (let key in params) {
                        sanitizedParams[key] = sanitizeInput(params[key]);
                    }
                    
                    const queryString = new URLSearchParams({
                        action,
                        ...sanitizedParams
                    }).toString();
                    
                    return makeRequest(`${CONFIG.GOOGLE_SCRIPT_URL}?${queryString}`);
                },
                
                post: async (data) => {
                    const sanitizedData = {};
                    for (let key in data) {
                        sanitizedData[key] = sanitizeInput(data[key]);
                    }
                    
                    return makeRequest(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(sanitizedData)
                    });
                }
            };
        })();
        
        // ‚úÖ UI Manager
        const UIManager = (() => {
            return {
                showMessage: (message, type) => {
                    const messageEl = DOM.get('otpMessage');
                    messageEl.textContent = message;
                    messageEl.className = `otp-message ${type}`;
                    messageEl.classList.remove('hidden');
                    
                    setTimeout(() => {
                        messageEl.classList.add('hidden');
                    }, 5000);
                },
                
                showLoading: (message = 'Processing...') => {
                    DOM.get('loadingMessage').textContent = message;
                    DOM.get('loadingOverlay').classList.remove('hidden');
                },
                
                hideLoading: () => {
                    DOM.get('loadingOverlay').classList.add('hidden');
                },
                
                showForm: () => {
                    DOM.get('form').classList.remove('hidden');
                },
                
                hideForm: () => {
                    DOM.get('form').classList.add('hidden');
                },
                
                showSuccess: () => {
                    DOM.get('form').classList.add('hidden');
                    DOM.get('alreadySubmitted').classList.remove('hidden');
                }
            };
        })();
        
        // ‚úÖ FIX #1: OTP Manager with 1-minute cooldown
        const secureOTPManager = (() => {
            const startCooldown = () => {
                let timeLeft = CONFIG.OTP_COOLDOWN_TIME;
                const sendBtn = DOM.get('sendOtpBtn');
                
                sendBtn.disabled = true;
                
                const updateButton = () => {
                    if (timeLeft > 0) {
                        sendBtn.innerHTML = `Wait <span class="otp-countdown">${timeLeft}s</span>`;
                        timeLeft--;
                    } else {
                        sendBtn.disabled = false;
                        sendBtn.textContent = 'Resend OTP';
                        clearInterval(secureStateManager.get('cooldownTimer'));
                    }
                };
                
                updateButton();
                const timer = setInterval(updateButton, 1000);
                secureStateManager.set('cooldownTimer', timer);
            };
            
            return {
                sendOTP: async () => {
                    const mobile = DOM.get('mobileInput').value.trim();
                    
                    if (!mobile || mobile.length !== 10 || !/^\d{10}$/.test(mobile)) {
                        UIManager.showMessage('Please enter a valid 10-digit mobile number', 'error');
                        return;
                    }
                    
                    UIManager.showLoading('Sending OTP...');
                    
                    try {
                        const result = await secureAPIManager.get('sendOTP', { mobile });
                        
                        UIManager.hideLoading();
                        
                        if (result.success && result.data.success) {
                            secureStateManager.set('otpSent', true);
                            secureStateManager.set('mobile', mobile);
                            
                            DOM.get('otpVerificationGroup').classList.remove('hidden');
                            DOM.get('mobileInput').disabled = true;
                            
                            // ‚úÖ FIX #2: Show success message
                            UIManager.showMessage('‚úÖ OTP sent successfully! Check your SMS.', 'success');
                            
                            // ‚úÖ FIX #1: Start 1-minute cooldown
                            startCooldown();
                            
                            setTimeout(() => DOM.get('otpInput').focus(), 300);
                        } else {
                            // ‚úÖ FIX #2: Better error messaging
                            const errorMsg = result.data?.message || 'Unable to send OTP. Please try again.';
                            UIManager.showMessage(errorMsg, 'error');
                        }
                    } catch (error) {
                        UIManager.hideLoading();
                        UIManager.showMessage('Error sending OTP. Please check your connection.', 'error');
                        console.error('OTP Error:', error);
                    }
                },
                
                verifyOTP: async () => {
                    const enteredOTP = DOM.get('otpInput').value.trim();
                    const mobile = secureStateManager.get('mobile');
                    
                    if (!enteredOTP || enteredOTP.length !== 6) {
                        UIManager.showMessage('Please enter a valid 6-digit OTP', 'error');
                        return;
                    }
                    
                    UIManager.showLoading('Verifying OTP...');
                    
                    try {
                        const result = await secureAPIManager.get('verifyOTP', { mobile, otp: enteredOTP });
                        
                        UIManager.hideLoading();
                        
                        if (result.success && result.data.success) {
                            secureStateManager.set('otpVerified', true);
                            UIManager.showMessage('‚úÖ OTP verified successfully!', 'success');
                            
                            if (secureStateManager.get('cooldownTimer')) {
                                clearInterval(secureStateManager.get('cooldownTimer'));
                            }
                            
                            setTimeout(() => {
                                DOM.get('otpSection').classList.add('hidden');
                                secureDataManager.fetchByMobile(mobile);
                            }, 1000);
                        } else {
                            UIManager.showMessage('‚ùå Invalid OTP. Please try again.', 'error');
                        }
                    } catch (error) {
                        UIManager.hideLoading();
                        UIManager.showMessage('Error verifying OTP. Please try again.', 'error');
                        console.error('Verify Error:', error);
                    }
                }
            };
        })();
        
        // ‚úÖ FIX #3: Data Manager optimized for large datasets
        const secureDataManager = (() => {
            const populateForm = (data) => {
                DOM.get('customerId').value = data.customerId || '';
                DOM.get('firstName').value = data.firstName || '';
                DOM.get('lastName').value = data.lastName || '';
                DOM.get('address1').value = data.address1 || '';
                DOM.get('address2').value = data.address2 || '';
                DOM.get('address3').value = data.address3 || '';
                DOM.get('pincode').value = data.pincode || '';
                DOM.get('city').value = data.city || '';
                DOM.get('state').value = data.state || '';
                DOM.get('emailId').value = data.emailId || '';
                
                updateAllCharCounts();
            };
            
            const enableAllFieldsExceptCustomerId = () => {
                const fields = ['firstName', 'lastName', 'address1', 'address2', 'address3', 'pincode', 'city', 'state', 'emailId'];
                fields.forEach(field => DOM.get(field).disabled = false);
                DOM.get('customerId').disabled = true;
            };
            
            return {
                fetchByMobile: async (mobile) => {
                    UIManager.showLoading('Fetching customer details...');
                    
                    try {
                        const result = await secureAPIManager.get('fetch', { mobile });
                        
                        UIManager.hideLoading();
                        
                        if (result.success && result.data.success && result.data.data) {
                            secureStateManager.set('customerData', result.data.data);
                            secureStateManager.set('rowIndex', result.data.data.rowIndex);
                            
                            populateForm(result.data.data);
                            UIManager.showForm();
                            enableAllFieldsExceptCustomerId();
                        } else {
                            UIManager.showMessage('Mobile number not found. Please search using Customer ID and Pincode.', 'info');
                            DOM.get('customerSearchSection').classList.remove('hidden');
                        }
                    } catch (error) {
                        UIManager.hideLoading();
                        UIManager.showMessage('Error fetching data. Please try again.', 'error');
                        console.error('Fetch Error:', error);
                    }
                },
                
                searchByIdAndPincode: async () => {
                    const customerId = DOM.get('customerIdSearch').value.trim();
                    const pincode = DOM.get('pincodeSearch').value.trim();
                    
                    if (!customerId) {
                        alert('Please enter a Customer ID');
                        return;
                    }
                    
                    if (!pincode || pincode.length !== 6) {
                        alert('Please enter a valid 6-digit Pincode');
                        return;
                    }
                    
                    UIManager.showLoading('Searching...');
                    
                    try {
                        const result = await secureAPIManager.get('fetchByCustomerIdAndPincode', { customerId, pincode });
                        
                        UIManager.hideLoading();
                        
                        if (result.success && result.data.success && result.data.data) {
                            secureStateManager.set('customerData', result.data.data);
                            secureStateManager.set('rowIndex', result.data.data.rowIndex);
                            
                            const currentMobile = DOM.get('mobileInput').value.trim() || secureStateManager.get('mobile');
                            const dbMobile = result.data.data.mobileNumber?.toString().trim();
                            
                            if (!dbMobile || dbMobile.length === 0 || dbMobile !== currentMobile) {
                                DOM.get('updatePhoneSection').classList.remove('hidden');
                                DOM.get('newMobileNumber').value = currentMobile || '';
                            } else {
                                populateForm(result.data.data);
                                DOM.get('customerSearchSection').classList.add('hidden');
                                UIManager.showForm();
                                enableAllFieldsExceptCustomerId();
                            }
                        } else {
                            alert(result.data?.message || 'Customer not found. Check ID and Pincode.');
                        }
                    } catch (error) {
                        UIManager.hideLoading();
                        alert('Error searching. Please try again.');
                        console.error('Search Error:', error);
                    }
                },
                
                updateMobile: async () => {
                    const newMobile = DOM.get('newMobileNumber').value.trim();
                    
                    if (!newMobile || newMobile.length !== 10 || !/^\d{10}$/.test(newMobile)) {
                        alert('Please enter a valid 10-digit mobile number');
                        return;
                    }
                    
                    const customerData = secureStateManager.get('customerData');
                    if (!customerData) {
                        alert('Customer data not found. Please search again.');
                        return;
                    }
                    
                    UIManager.showLoading('Updating mobile number...');
                    
                    try {
                        const result = await secureAPIManager.post({
                            action: 'updateMobile',
                            rowIndex: secureStateManager.get('rowIndex'),
                            customerId: customerData.customerId,
                            pincode: customerData.pincode,
                            newMobile: newMobile
                        });
                        
                        UIManager.hideLoading();
                        
                        if (result.success && result.data.success) {
                            alert('‚úÖ Mobile number updated successfully!');
                            customerData.mobileNumber = newMobile;
                            secureStateManager.set('mobile', newMobile);
                            
                            populateForm(customerData);
                            DOM.get('customerSearchSection').classList.add('hidden');
                            DOM.get('updatePhoneSection').classList.add('hidden');
                            UIManager.showForm();
                            enableAllFieldsExceptCustomerId();
                        } else {
                            alert('Error updating mobile: ' + (result.data?.message || 'Unknown error'));
                        }
                    } catch (error) {
                        UIManager.hideLoading();
                        alert('Error updating mobile. Please try again.');
                        console.error('Update Mobile Error:', error);
                    }
                },
                
                submitForm: async (formData) => {
                    UIManager.showLoading('Submitting...');
                    
                    try {
                        const result = await secureAPIManager.post(formData);
                        
                        UIManager.hideLoading();
                        
                        if (result.success && result.data.success) {
                            UIManager.showSuccess();
                        } else {
                            alert('Error: ' + (result.data?.message || 'Failed to update address'));
                            DOM.get('submitBtn').disabled = false;
                            DOM.get('submitBtn').textContent = 'Submit Address Update';
                        }
                    } catch (error) {
                        UIManager.hideLoading();
                        alert('An error occurred. Please try again.');
                        console.error('Submit Error:', error);
                        DOM.get('submitBtn').disabled = false;
                        DOM.get('submitBtn').textContent = 'Submit Address Update';
                    }
                }
            };
        })();
        
        // Character count functions
        function updateCharCount(input, countSpan) {
            countSpan.textContent = input.value.length;
        }
        
        function updateAllCharCounts() {
            updateCharCount(DOM.get('address1'), document.getElementById('address1Count'));
            updateCharCount(DOM.get('address2'), document.getElementById('address2Count'));
            updateCharCount(DOM.get('address3'), document.getElementById('address3Count'));
        }
        
        // Event listeners
        DOM.get('address1').addEventListener('input', function() {
            updateCharCount(this, document.getElementById('address1Count'));
        });
        
        DOM.get('address2').addEventListener('input', function() {
            updateCharCount(this, document.getElementById('address2Count'));
        });
        
        DOM.get('address3').addEventListener('input', function() {
            updateCharCount(this, document.getElementById('address3Count'));
        });
        
        // Pincode lookup
        DOM.get('pincode').addEventListener('input', async function(e) {
            const pincode = e.target.value.trim();
            
            if (pincode.length === 6) {
                const pincodeStatus = document.getElementById('pincodeStatus');
                pincodeStatus.textContent = 'üîç Fetching location...';
                pincodeStatus.className = 'pincode-status loading';
                pincodeStatus.style.display = 'block';
                
                try {
                    const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                    const data = await response.json();
                    
                    if (data && data[0] && data[0].Status === 'Success' && data[0].PostOffice && data[0].PostOffice.length > 0) {
                        const postOffice = data[0].PostOffice[0];
                        
                        pincodeStatus.textContent = '‚úÖ Location found!';
                        pincodeStatus.className = 'pincode-status success';
                        
                        DOM.get('city').value = postOffice.District || postOffice.Block || '';
                        DOM.get('state').value = postOffice.State || '';
                        
                        setTimeout(() => pincodeStatus.style.display = 'none', 3000);
                    } else {
                        pincodeStatus.textContent = '‚ùå Invalid pincode';
                        pincodeStatus.className = 'pincode-status error';
                        setTimeout(() => pincodeStatus.style.display = 'none', 4000);
                    }
                } catch (error) {
                    pincodeStatus.textContent = '‚ö†Ô∏è Error fetching location';
                    pincodeStatus.className = 'pincode-status error';
                    setTimeout(() => pincodeStatus.style.display = 'none', 4000);
                }
            }
        });
        
        // Form submission
        DOM.get('form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!DOM.get('address1').value.trim() || !DOM.get('address2').value.trim() || 
                !DOM.get('pincode').value.trim() || !DOM.get('city').value.trim() || !DOM.get('state').value.trim()) {
                alert('Please fill all required fields');
                return;
            }
            
            DOM.get('submitBtn').disabled = true;
            DOM.get('submitBtn').textContent = 'Submitting...';
            
            const formData = {
                action: 'update',
                rowIndex: secureStateManager.get('rowIndex'),
                customerId: DOM.get('customerId').value,
                mobileNumber: secureStateManager.get('mobile') || secureStateManager.get('customerData')?.mobileNumber,
                firstName: DOM.get('firstName').value,
                lastName: DOM.get('lastName').value,
                address1: DOM.get('address1').value,
                address2: DOM.get('address2').value,
                address3: DOM.get('address3').value,
                pincode: DOM.get('pincode').value,
                city: DOM.get('city').value,
                state: DOM.get('state').value,
                emailId: DOM.get('emailId').value
            };
            
            await secureDataManager.submitForm(formData);
        });
        
        // Enter key handlers
        DOM.get('mobileInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                secureOTPManager.sendOTP();
            }
        });
        
        DOM.get('otpInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                secureOTPManager.verifyOTP();
            }
        });
        
        // Initialize from URL
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const rightLogoUrl = urlParams.get('rightLogo');
            const logoSize = urlParams.get('logoSize');
            
            if (rightLogoUrl) {
                document.getElementById('rightLogo').src = decodeURIComponent(rightLogoUrl);
            }
            
            if (logoSize) {
                const size = parseInt(decodeURIComponent(logoSize));
                if (!isNaN(size) && size > 0 && size <= 300) {
                    document.documentElement.style.setProperty('--logo-size', `${size}px`);
                }
            }
        })();
        
        // ‚úÖ FIX #4: Security - Disable console access in production
        if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            console.log = () => {};
            console.error = () => {};
            console.warn = () => {};
            console.info = () => {};
        }
        
        console.log('‚úÖ Kalyan Form Initialized - Production Ready');
    </script>
</body>
</html>
